{% load i18n placeholder_admin_tags %}{% comment %}
  This is the admin template to render the PlaceholderInline.
  It renders tab buttons for each inline, and registers them as "placeholder panes" for the editor.

  inline_admin_formset = generated InlineAdminFormSet of the PlaceholderInline. Each form holds a placeholder.
  inline_admin_formset.opts = PlaceholderInline object

  inline_admin_formsets = all InlineAdminFormSet objects of the parent
{% endcomment %}
<script type="text/javascript">
  // Pass database data to the cp_admin.js file.
  // Each tab hosts a placeholder pane.
  var placeholders = {% block js_placeholders %}[ {% for inline_admin_form in inline_admin_formset %}{% with placeholder=inline_admin_form.original %}{
                      id: {{ placeholder.id|default:"''" }},
                      slot: '{{ placeholder.slot|default:forloop.counter0|escapejs }}',
                      title: '{{ placeholder.title|escapejs }}',
                      role: '{{ placeholder.role }}',
                      domnode: 'tab-region-{{ placeholder.slot|default:forloop.counter0 }}'
                    }{% if not forloop.last %}, {% endif %}
                  {% endwith %}{% endfor %}]{% endblock %};
  var itemtypes = {% block js_contentitemtypes %}{ {% for fs in inline_admin_formsets|only_content_item_formsets %}'{{ fs.opts.type_name|escapejs }}': {
                      type: '{{ fs.opts.type_name|escapejs }}',{# fs.opts = ContentItemInline #}
                      name: '{{ fs.opts.name|escapejs }}',
                      prefix: '{{ fs.formset.prefix|escapejs }}',{# fs.formset = targetobjectformFormSet #}
                      rel_name: '{{ fs.formset.rel_name|escapejs }}',
                      auto_id: '{{ fs.formset.auto_id|escapejs }}'
                    }{% if not forloop.last %}, {% endif %}
                  {% endfor %}}{% endblock %};
  cp_admin.setPlaceholders( placeholders );
  cp_admin.setContentItemTypes( itemtypes );
</script>

  <div id="{{ inline_admin_formset.formset.prefix }}-group" class="inline-group inline-placeholder-group">
    {{ inline_admin_formset.formset.management_form }}
    {{ inline_admin_formset.formset.non_form_errors }}

    {# looping in `inline_admin_formset.formset.forms` excludes empty form #}
    {# looping in `<inline></inline>_admin_formset` includes the empty placeholder as last item #}

    {# tab navigation #}
    {# each inline object is a placeholders #}
    <ul id="cp-tabnav" class="cp-clearfix">
      {% for inline_admin_form in inline_admin_formset %}{% with placeholder=inline_admin_form.original %}
      <li class="cp-region{% if forloop.first %} active{% endif %}"><a href="#tab-region-{{ placeholder.slot|default:forloop.counter0 }}">{{ placeholder|default_if_none:"new..." }}</a></li>
      {% endwith %}{% endfor %}
      <li id="cp-tabnav-loading" style="display: none"><a href="#">{% trans "Loading layout data..." %}</a></li>
      <li id="cp-tabnav-orphaned" style="display: none"><a href="#tab-orphaned">{% trans "Orphaned content" %}</a></li>
      <li id="cp-tabnav-template" style="display: none"><a href="#">EMPTY</a></li>
      {% block tabnav_end %}{% endblock %}
    </ul>

    <div id="cp-tabmain" class="module">
      {# all the region tabs #}
      {% for inline_admin_form in inline_admin_formset %}{% with placeholder=inline_admin_form.original %}
        {% if placeholder %}{% with cp_plugin_list=placeholder.get_allowed_plugins placeholder_slot=placeholder.slot placeholder_id=placeholder.id %}
        {# existing placeholder #}
        <div class="cp-tab cp-region-tab{% if forloop.first %} cp-tab-active{% endif %}" id="tab-region-{{ placeholder.slot|default:forloop.counter0 }}">
          {% include "admin/content_placeholders/placeholderfield/pane.html" %}
        {% endwith %}{% else %}{% with cp_plugin_list=inline_admin_formset.opts.get_all_allowed_plugins placeholder_slot=forloop.counter0 placeholder_id=0 %}
        {# new extra item #}
        <div class="cp-tab cp-region-tab{% if forloop.first %} cp-tab-active{% endif %}" id="tab-region-{{ forloop.counter0 }}">
          {% include "admin/content_placeholders/placeholderfield/pane.html" %}
        {% endwith %}{% endif %}

          {# fields #}
          {% if inline_admin_form.has_auto_field %}{{ inline_admin_form.pk_field.field }}{% endif %}
          {{ inline_admin_form.fk_field.field }}

          {% for fieldset in inline_admin_form %}
          {% for line in fieldset %}{% for adminfield in line %}
            {{ adminfield.field.as_hidden }}
          {% endfor %}{% endfor %}{% endfor %}
        </div>
      {% endwith %}{% endfor %}

      {# Repeated again, as empty placeholder #}
      {% with cp_plugin_list=inline_admin_formset.opts.get_all_allowed_plugins placeholder_slot="EMPTY" placeholder_id="" %}
      <div class="cp-tab" id="tab-template">
        {% include "admin/content_placeholders/placeholderfield/pane.html" %}
      </div>
      {% endwith %}

      {# this is a "lost+found" bucket for layout switching #}
      <div class="cp-tab" id="tab-orphaned">
        <div class="cp-tab-content">
        </div>
      </div>

      {# all remaining fieldsets #}
      {% block tabmain_end %}{% endblock %}
    </div><!-- /cp-tabmain -->
  </div><!-- /cp-tabbar -->
